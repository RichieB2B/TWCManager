# Docker Image Installation

## Docker Installation

Install Docker (and docker-compose) on your target machine, and fetch the TWCManager Git repository with the following commands:

```
sudo apt-get update
sudo apt-get install -y git docker.io

pip3 install docker-compose
git clone https://github.com/ngardiner/TWCManager
cd TWCManager
```

### Note

The instructions below will result in the **latest** version of the TWCManager code being run. This is development code and may not be stable, but will provide access to the newer features. The **latest** image is automatically updated every time that new features or fixes are added to TWCManager, and will change regularly.

If you would like to opt for a more stable version, edit the ```contrib/docker/docker-compose.yml``` file and modify the following line:

```
image: twcmanager/twcmanager:latest
```

to reference the specific version of TWCManager that you would like to run, for example:

```
image: twcmanager/twcmanager:v1.2.1
```

## Configuring TWCManager in Docker

You may need to perform some configuration of TWCManager in your environment.

   * docker-compose.yml

The default ```docker-compose.yml``` file assumes that you will be using Serial interface ```/dev/ttyUSB0``` on the host machine as the serial port to communicate with the TWCs you are managing. If this is not the case, you will need to edit the file and specify the correct interface.

   * /etc/twcmanager/config.json

On your first start of the TWCManager docker container, a directory on the host will be created if it does not currently exist, and the default configuration file will be copied there. The location of this volume is ```/etc/twcmanager```. If you need to edit the configuration file, run the Docker container in interactive mode (instructions below), exit with Ctrl+C and then edit the ```/etc/twcmanager/config.json``` file that was created.

## Starting TWCManager

To start up TWCManager in interactive mode, run the following command:

```
docker-compose -f contrib/docker/docker-compose.yml up
```

To start up TWCManager in background mode, run the following command:

```
docker-compose -d -f contrib/docker/docker-compose.yml up
```

## Monitoring the container operation

After starting TWCManager, the script will run in the foreground and will regularly update with the current status. If you specified detach mode (with the ```-d``` parameter), the information can be viewed by using the ```docker logs docker_twcmanager_1 -f``` command.

An example output is as follows:

<pre>
twcmanager_1  | 11:57:49: <b>SHA 1234</b>: 00 <b>00.00/00.00A</b> 0000 0000  <b>M</b>: 09 <b>00.00/17.00A</b> 0000 0000
twcmanager_1  | 11:57:49: Green energy generates <b>4956W</b>, Consumption <b>726W</b>, Charger Load <b>0W</b>
twcmanager_1  |          Limiting car charging to 20.65A - 3.03A = <b>17.62A</b>.
twcmanager_1  |          Charge when above <b>6A</b> (minAmpsPerTWC).
</pre>

   * SHA 1234 is the reported TWC code for each of the Slave TWCs that the Master is connected to.
   * The 00.00/00.00A next to the Slave TWC code is the current number of amps being utilised and the total number of amps available to that slave. The master divides the total amperage available for use between the connected slaves.
   * M is the same values for the Master device (our script). It shows current utilization and total available amps (in this case, 17A) available for all connected slaves.

   * The second line shows the green energy values detected. In this case, the attached green energy device (solar inverter) is reporting 4956W being generated from solar, 726W being used by other household appliances, and no load being generated by the charger. As we charge a vehicle, that value will increase and maybe subtracted from the consumption value if configured to do so.
   * The line below this reports the same values but in amps instead of watts.
   * The final line shows the minAmpsPerTWC value, which is the minimum number of amps that the master must offer each slave before we tell the attached vehicle to charge (via the Tesla API).

## Upgrading TWCManager

To upgrade the version of TWCManager that you are running under Docker, execute
the following commands:

```
git pull
docker-compose -f contrib/docker/docker-compose.yml down
docker-compose -f contrib/docker/docker-compose.yml pull
docker-compose -d -f contrib/docker/docker-compose.yml up
```

## Stopping TWCManager

You may stop the TWCManager container in the following ways:

   * Interactive Mode

Press ```Ctrl + C``` in the console of the Docker Container to stop TWCManager from running

   * Background Mode

Use the following command to stop TWCManager's docker container from running in Background Mode:

```
docker-compose -f contrib/docker/docker-compose.yml down
```

## Starting TWCManager at Boot

To be completed
